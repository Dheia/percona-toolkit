#!/bin/bash

DIR=$(dirname "$0")
source ${DIR}/env.sh 

get_single_profile() {
    $CMD --quiet <<'EOF'
    {
        var sp = db.system.profile.find().sort( { ts : -1 } ).limit(20).toArray();
        for (let i=0; i < sp.length; i++) {
             if (sp[i].ns != "admin.test_db.coll"){
                 continue;
             }

        if ("ts" in sp[i]) {
            sp[i].ts = ISODate("2020-01-01T00:00:00.000Z")
        }
        if ("millis" in sp[i]) {
            sp[i].millis = 42
        }
        if ("lockStats" in sp[i]) {
            if ("timeLockedMicros" in sp[i].lockStats) {
                if ("r" in sp[i].lockStats.timeLockedMicros) {
                    sp[i].lockStats.timeLockedMicros.r = NumberLong(1234)
                    sp[i].lockStats.timeLockedMicros.w = NumberLong(4321)
                }
                if ("R" in sp[i].lockStats.timeLockedMicros) {
                    sp[i].lockStats.timeLockedMicros.R = NumberLong(1234)
                    sp[i].lockStats.timeLockedMicros.W = NumberLong(4321)
                }
            }
            if ("timeAcquiringMicros" in sp[i].lockStats) {
                if ("r" in sp[i].lockStats.timeAcquiringMicros) {
                    sp[i].lockStats.timeAcquiringMicros.r = NumberLong(9876)
                    sp[i].lockStats.timeAcquiringMicros.w = NumberLong(6789)
                }
                if ("R" in sp[i].lockStats.timeAcquiringMicros) {
                    sp[i].lockStats.timeAcquiringMicros.R = NumberLong(9876)
                    sp[i].lockStats.timeAcquiringMicros.W = NumberLong(6789)
                }
            }
        }
        print(JSON.stringify(sp[i], "   ", 2));
        break;
       } 
    }
EOF
}
